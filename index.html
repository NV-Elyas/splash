<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Splash Web</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <style>
    :root{
      --bg:#0e0e10;
      --panel:#1b1b1e;
      --acc:#ff4444;       /* starke Akzentfarbe (rot) */
      --acc2:#6c7cff;      /* zweite starke Farbe (für später) */
      --text:#fff;
      --muted:#9aa0a6;
      --radius:20px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      overflow:hidden;
    }
    /* Screen-Container */
    .screen{
      position:relative;
      display:none;
      width:100%;
      height:100svh;              /* mobile-safe viewport */
      padding:20px 16px 28px;
      overflow:auto;
      -webkit-overflow-scrolling:touch; 
    }
    .active{display:block}

    /* Startseite – Karten */
    .stack{max-width:520px; margin:0 auto; display:grid; gap:18px}
    .game-card-link{
      position:relative;
      width:100%; aspect-ratio: 7/10; border-radius: var(--radius);
      border:4px solid #fff; overflow:hidden; cursor:pointer;
      display:flex; align-items:flex-end; justify-content:center;
      background:#222 center/cover no-repeat;
      box-shadow: 0 10px 20px rgba(0,0,0,.35);
      transition: transform .12s ease;
    }
    .game-card-link:active{transform:scale(.98)}
    .badge{
      position:absolute; top:10px; right:10px; background:rgba(0,0,0,.55);
      padding:6px 10px; border-radius:999px; font-size:.85rem;
      border:1px solid rgba(255,255,255,.25)
    }
    .card-title{
      width:100%; text-align:center; padding:14px 10px; font-weight:800;
      font-size: clamp(1.2rem, 4vw, 1.6rem); text-shadow: 0 3px 6px rgba(0,0,0,.45);
      background: linear-gradient(180deg, transparent, rgba(0,0,0,.25), rgba(0,0,0,.45));
    }
    .imposter-cover{ background-image: url('https://placehold.co/800x1100/ff5a5a/ffffff?text=FINDET+DEN+IMPOSTER'); }
    .liar-cover{     background-image: url('https://placehold.co/800x1100/6c7cff/ffffff?text=FINDE+DEN+L%C3%9CGNER'); }

    /* Panels / Inputs */
    .panel{background:var(--panel); border-radius:16px; padding:12px}
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px; margin:8px 0}
    .col{display:flex; flex-direction:column; gap:8px}
    .title{font-size:1.6rem; font-weight:800; margin:2px 0 6px}
    .muted{color:var(--muted); font-size:.95rem}
    input[type="text"], select{
      width:100%; padding:12px 14px; border:none; border-radius:12px; background:#2a2a30; color:#fff; font-size:1rem;
      outline: none;
    }
    .btn{
      width:100%; padding:14px 16px; border:none; border-radius:16px; font-weight:800; cursor:pointer;
      background:var(--acc); color:#fff; font-size:1.05rem; box-shadow: 0 8px 18px rgba(255,68,68,.25);
    }
    .btn:active{transform: translateY(1px)}
    .btn-secondary{background:#3a3a42; box-shadow:none}
    .btn-chip{padding:10px 14px; border-radius:12px; background:#2a2a30; border:1px solid #3a3a42; font-weight:700}

    /* iOS-Style Switch */
    .switch{position:relative; width:52px; height:30px}
    .switch input{display:none}
    .slider{position:absolute; inset:0; background:#666; border-radius:999px; transition:.25s}
    .slider:before{
      content:""; position:absolute; left:3px; top:3px; width:24px; height:24px; background:#fff; border-radius:50%;
      transition: transform .25s;
    }
    .switch input:checked + .slider{background:#34c759}
    .switch input:checked + .slider:before{transform: translateX(22px)}

    /* Setup: Spieler-Liste */
    .player-item{padding:10px 0; border-bottom:1px solid #2f2f36; display:flex; align-items:center; justify-content:space-between; gap:8px}
    .player-item:last-child{border-bottom:none}
    .del{background:#3a3a42; border:none; color:#fff; border-radius:10px; padding:6px 10px}

    .player-name-input {
      flex: 1;
      padding: 8px 10px;
      border: none;
      border-radius: 8px;
      background: #2a2a30;
      color: #fff;
      font-size: 1rem;
    }
    .player-name-input:focus {
      outline: 2px solid var(--acc);
    }

    .reveal-card {
      width:min(92%, 420px);
      aspect-ratio: 3/4;
      border-radius:24px;
      background:#fff;
      color:#000;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-weight:900;
      font-size:clamp(1.2rem, 6vw, 1.8rem);
      margin:10px auto;
      box-shadow:0 12px 30px rgba(0,0,0,.35);
      user-select:none;
    }
    .reveal-card.hidden {
      background:var(--acc);
      color:#fff;
    }
    #cardHintText {
      font-size:1rem;
      font-weight:700;
      margin-top:8px;
      display:none;
    }

    .hint {
      font-size: 0.85rem;
      margin-top: 10px;
      text-align: center;
      display: none;
      color: var(--muted);
    }
    .topbar{display:flex; align-items:center; justify-content:space-between}
    .topbar .back{padding:8px 12px; border-radius:12px; background:#26262b; border:1px solid #333; font-weight:700}

    /* Spiel-Screen */
    .game-hero{
      text-align:center;
      margin:8px auto 14px;
      font-weight:900;
      font-size: clamp(1.2rem, 5.5vw, 1.8rem);
    }
    .timer{
      font-variant-numeric: tabular-nums;
      font-weight:900; font-size: clamp(1.2rem, 6vw, 1.8rem);
      background:#26262b; padding:10px 14px; border-radius:12px; display:inline-block; min-width:96px;
      border:1px solid #333;
    }
    .reveal-list{margin-top:14px; line-height:1.7}

    /* ===== Modal Styles ===== */
    .modal{ position:fixed; inset:0; display:none; z-index:999; }
    .modal.show{ display:block; }
    .modal-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.5); backdrop-filter: blur(2px); }
    .modal-panel{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:min(92%,520px); background:var(--panel); border-radius:16px; padding:14px;
      box-shadow: 0 16px 40px rgba(0,0,0,.45); border:1px solid #2a2a30;
      max-height: 80vh; display:flex; flex-direction:column; gap:10px;
    }
    .modal-header{ display:flex; align-items:center; justify-content:space-between; }
    .modal-close{ background:#2a2a30; color:#fff; border:1px solid #3a3a42; border-radius:10px; padding:6px 10px; }
    .modal-search{
      width:100%; padding:12px 14px; border:none; border-radius:12px; background:#2a2a30; color:#fff; font-size:1rem;
    }
    .cat-list{ overflow:auto; -webkit-overflow-scrolling:touch; display:flex; flex-direction:column; gap:8px; padding:4px 2px; }
    .cat-item{
      padding:12px 14px; border-radius:12px; background:#22232a; border:1px solid #32333b; cursor:pointer;
      display:flex; align-items:center; justify-content:space-between; font-weight:700;
    }
    .cat-item:active{ transform:scale(.995); }
    .cat-item.active{ outline:2px solid var(--acc); }
    .modal-footer{ display:flex; gap:10px; }
    /* --------- Lügner-Spiel Ergänzungen --------- */
    .answer-input{
      width:100%; padding:14px; border:none; border-radius:12px;
      background:#2a2a30; color:#fff; font-size:1rem; outline:none;
    }
    .answers-grid{
      display:grid; gap:12px;
      grid-template-columns: repeat(auto-fill, minmax(240px,1fr));
    }
    .answer-card{
      background:#22232a; border:1px solid #32333b; border-radius:16px;
      padding:12px 14px; box-shadow: 0 6px 16px rgba(0,0,0,.25);
    }
    .answer-name{ font-weight:800; margin-bottom:6px }
    .answer-text{ font-size:1.02rem; line-height:1.4 }
    .answer-card.liar{ outline:3px solid var(--acc) }
  </style>
</head>
<body>

  <!-- ============ Startseite ============ -->
  <section id="start" class="screen active">
    <div class="stack">
      <div class="game-card-link imposter-cover" onclick="navTo('setup')">
        <span class="badge">3–20</span>
        <div class="card-title">FINDET DEN IMPOSTER</div>
      </div>
      <div class="game-card-link liar-cover" onclick="navTo('liar-setup')">
        <span class="badge">3–15</span>
        <div class="card-title">FINDE DEN LÜGNER</div>
      </div>
    </div>
  </section>

  <!-- ============ Setup ============ -->
  <section id="setup" class="screen">
    <div class="topbar">
      <button class="back" onclick="navTo('start')">‹ Zurück</button>
      <div class="muted">Imposter – Setup</div>
      <div style="width:84px"></div>
    </div>

    <h1 class="title">Spieler</h1>
    <div class="panel">
      <div class="row">
        <input id="playerInput" type="text" placeholder="Spielername eingeben" onkeydown="if(event.key==='Enter') addPlayer()" />
        <button class="btn-chip" onclick="addPlayer()">+ Hinzufügen</button>
      </div>
      <div id="playerList"></div>
      <div class="row" style="margin-top:8px;">
        <div class="muted" id="playerCount">0 Spieler</div>
        <div class="muted">min. 3 • max. 20</div>
      </div>
    </div>

    <h2 class="title" style="margin-top:8px">Imposter</h2>
    <div class="panel">
      <div class="row">
        <div>Wie viele?</div>
        <select id="imposterCount">
          <option value="1" selected>1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select>
      </div>
      <div class="row">
        <div>Hinweise für Imposter</div>
        <label class="switch">
          <input id="hintsSwitch" type="checkbox" />
          <span class="slider"></span>
        </label>
      </div>
      <div class="row">
        <div>Kategorien</div>
        <div style="display:flex; gap:8px; align-items:center">
          <div id="catBadge" class="muted" style="min-width:100px; text-align:right">Zufällig</div>
          <button class="btn-chip" onclick="openCatModal()">Auswählen</button>
        </div>
      </div>
    </div>

    <h2 class="title" style="margin-top:8px">Zeitlimit</h2>
    <div class="panel">
      <div class="row">
        <div>Timer aktivieren</div>
        <label class="switch">
          <input id="timerSwitch" type="checkbox" onchange="toggleTimerUI()" />
          <span class="slider"></span>
        </label>
      </div>
      <div class="row" id="timerRow" style="display:none">
        <div>Dauer</div>
        <select id="timerMinutes">
          <option value="5">5 Minuten</option>
          <option value="7">7 Minuten</option>
          <option value="10" selected>10 Minuten</option>
          <option value="15">15 Minuten</option>
          <option value="20">20 Minuten</option>
        </select>
      </div>
    </div>

    <button class="btn" style="margin-top:10px" onclick="beginCards()">Spiel starten</button>
  </section>

  <!-- ============ Karten-Screen ============ -->
  <section id="cards" class="screen" style="background:#ff4444;">
    <div class="topbar" style="margin-bottom:6px">
      <button class="back" onclick="restartToSetup()">‹ Setup</button>
      <div style="font-weight:800">Imposter</div>
      <div style="width:84px"></div>
    </div>

    <div id="cardPlayerName" class="game-hero">Spieler</div>

    <!-- Karte mit Haupttext und Hinweis -->
    <div id="revealCard" class="reveal-card hidden" onclick="revealCurrent()">
      <div id="cardMainText">Karte aufdecken</div>
      <div id="cardHintText" class="hint"></div>
    </div>

    <button id="nextBtn" class="btn" style="display:none; margin-top:12px" onclick="nextCard()">Weitergeben</button>

    <div class="muted" style="margin-top:auto">
      Ziehe deine Karte hoch/Tippen, um sie aufzudecken. Achte darauf, dass niemand sonst es sieht.
    </div>
  </section>

  <!-- ============ Spiel-Screen ============ -->
  <section id="play" class="screen">
    <div class="topbar">
      <button class="back" onclick="restartToSetup()">‹ Setup</button>
      <div style="font-weight:800">Imposter</div>
      <div style="width:84px"></div>
    </div>

    <h1 class="game-hero">FINDE DEN IMPOSTER</h1>

    <div class="panel">
      <div class="row">
        <div>Startspieler</div>
        <div id="starter" style="font-weight:800"></div>
      </div>
      <div class="row">
        <div>Timer</div>
        <div id="timerBox" class="timer">—:—</div>
      </div>
    </div>

    <button class="btn" style="margin-top:16px" onclick="revealImposters()">Imposter aufdecken</button>
    <div id="revealOut" class="panel reveal-list" style="display:none"></div>

    <div class="muted" style="margin-top:auto">
      Für dieses Spiel gibt es keinen festen Ablauf – deckt den/die Imposter auf, sobald ihr euch einig seid.
    </div>
  </section>

    <!-- ============ Lügner – Setup ============ -->
  <section id="liar-setup" class="screen">
    <div class="topbar">
      <button class="back" onclick="navTo('start')">‹ Zurück</button>
      <div class="muted">Finde den Lügner – Setup</div>
      <div style="width:84px"></div>
    </div>

    <h1 class="title">Spieler</h1>
    <div class="panel">
      <div class="row">
        <input id="liarPlayerInput" type="text" placeholder="Spielername eingeben"
              onkeydown="if(event.key==='Enter') liarAddPlayer()" />
        <button class="btn-chip" onclick="liarAddPlayer()">+ Hinzufügen</button>
      </div>
      <div id="liarPlayerList"></div>
      <div class="row" style="margin-top:8px;">
        <div class="muted" id="liarPlayerCount">0 Spieler</div>
        <div class="muted">min. 3 • max. 15</div>
      </div>
    </div>

    <h2 class="title" style="margin-top:8px">Lügner</h2>
    <div class="panel">
      <div class="row">
        <div>Wie viele?</div>
        <select id="liarCount">
          <option value="1" selected>1</option>
          <option value="2">2</option>
          <option value="3">3</option>
        </select>
      </div>
      <div class="row">
        <div>Kategorien</div>
        <div style="display:flex; gap:8px; align-items:center">
          <div id="liarCatBadge" class="muted" style="min-width:100px; text-align:right">Zufällig</div>
          <button class="btn-chip" onclick="liarOpenCatModal()">Auswählen</button>
        </div>
      </div>
    </div>

    <button class="btn" style="margin-top:10px" onclick="liarBeginCards()">Spiel starten</button>
  </section>

  <!-- ============ Lügner – Karten/Aufdecken + Frage/Antwort ============ -->
  <section id="liar-cards" class="screen" style="background:#6c7cff;">
    <div class="topbar" style="margin-bottom:6px">
      <button class="back" onclick="liarRestartToSetup()">‹ Setup</button>
      <div style="font-weight:800">Finde den Lügner</div>
      <div style="width:84px"></div>
    </div>

    <div id="liarCardPlayerName" class="game-hero">Spieler</div>

    <div id="liarRevealCard" class="reveal-card hidden" onclick="liarRevealCurrent()">
      <div id="liarCardMainText">Karte aufdecken</div>
    </div>

    <div id="liarAnswerWrap" class="panel" style="display:none; margin-top:10px">
      <div class="muted" id="liarQuestionShown">Frage …</div>
      <input id="liarAnswerInput" class="answer-input" placeholder="Deine Antwort" />
    </div>

    <button id="liarNextBtn" class="btn" style="display:none; margin-top:12px" onclick="liarNextCard()">Weitergeben</button>
    <div class="muted" style="margin-top:auto">Tippe zum Aufdecken, antworte – und gib weiter.</div>
  </section>

  <!-- ============ Lügner – Antworten/Übersicht ============ -->
  <section id="liar-results" class="screen">
    <div class="topbar">
      <button class="back" onclick="liarRestartToSetup()">‹ Setup</button>
      <div style="font-weight:800">Finde den Lügner</div>
      <div style="width:84px"></div>
    </div>

    <h1 id="liarPublicQuestion" class="game-hero">Frage</h1>

    <div class="answers-grid" id="liarAnswersGrid"></div>

    <button class="btn" style="margin-top:16px" onclick="liarRevealLiars()">Lügner aufdecken</button>
    <button class="btn-secondary" style="margin-top:8px" onclick="navTo('start')">Neustart</button>
  </section>

  <!-- ===== Lügner – Kategorien-Modal ===== -->
  <div id="liarCatModal" class="modal">
    <div class="modal-backdrop" onclick="liarCloseCatModal()"></div>
    <div class="modal-panel">
      <div class="modal-header">
        <div style="font-weight:800">Kategorie(n) wählen</div>
        <button class="modal-close" onclick="liarCloseCatModal()">✕</button>
      </div>

      <input id="liarCatSearch" type="text" class="modal-search" placeholder="Suchen..." oninput="liarFilterCategories()" />
      <div id="liarCatList" class="cat-list"></div>

      <div class="modal-footer">
        <button class="btn-secondary" onclick="liarChooseRandom()">🎲 Zufällig</button>
        <button class="btn" onclick="liarApplyCategories()">Übernehmen</button>
      </div>
    </div>
  </div>


  <!-- ===== Kategorien-Modal ===== -->
  <div id="catModal" class="modal">
    <div class="modal-backdrop" onclick="closeCatModal()"></div>
    <div class="modal-panel">
      <div class="modal-header">
        <div style="font-weight:800">Kategorie wählen</div>
        <button class="modal-close" onclick="closeCatModal()">✕</button>
      </div>

      <input id="catSearch" type="text" class="modal-search" placeholder="Suchen..." oninput="filterCategories()"/>

      <div id="catList" class="cat-list"></div>

      <div class="modal-footer">
        <button class="btn-secondary" onclick="chooseRandom()">🎲 Zufällig</button>
        <button class="btn" onclick="applyCategory()">Übernehmen</button>
      </div>
    </div>
  </div>

  <script>
    // ----------- State -----------
    let players = [];
    let impostersIdx = [];
    let currentIndex = 0;

    // Kategorien / Begriffe
    let kategorien = {};           // alle Kategorien + Begriffe
    let aktiveKategorien = [];     // aktuell gewählt
    let aktuellerBegriff = null;   // gezogener Begriff
    let tmpSelectedCategories = [];

    // Timer
    let timerActive = false;
    let timerTotalSec = 0;
    let timerLeft = 0;
    let timerInterval = null;

    // ----------- Begriffe laden -----------
    fetch("begriffe.json")
      .then(res => res.json())
      .then(data => {
        kategorien = data;
        aktiveKategorien = []; // noch keine gewählt
        updateCategoryButtonLabel();
      })
      .catch(err => console.error("Fehler beim Laden:", err));

    // ----------- Helpers UI -----------
    const $ = sel => document.querySelector(sel);
    function navTo(id){
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }
    function toggleTimerUI(){
      $('#timerRow').style.display = $('#timerSwitch').checked ? 'flex' : 'none';
    }

    // ----------- Kategorien-Modal -----------
    let tmpSelectedCategory = null;

    function updateCategoryButtonLabel() {
      const btn = document.querySelector('button.btn-chip[onclick*="openCatModal"]');
      if (btn) {
        btn.textContent = aktiveKategorien.length 
          ? `${aktiveKategorien.length} gewählt` 
          : 'Auswählen';
      }
      const badge = $('#catBadge');
      if (badge) {
        badge.textContent = aktiveKategorien.length 
          ? aktiveKategorien.join(', ') 
          : 'Zufällig';
      }
    }

    function openCatModal() {
      if (Object.keys(kategorien).length === 0) {
        alert("Kategorien werden noch geladen...");
        return;
      }
      // Aktuell gewählte Kategorien kopieren
      tmpSelectedCategories = [...aktiveKategorien];
      buildCategoryList();
      $('#catSearch').value = '';
      $('#catModal').classList.add('show');
      document.body.style.overflow = 'hidden';
    }
    function closeCatModal(){
      $('#catModal').classList.remove('show');
      document.body.style.overflow = '';
    }
    function buildCategoryList(filter=''){
      const list = $('#catList');
      list.innerHTML = '';
      const keys = Object.keys(kategorien)
        .sort((a,b)=> a.localeCompare(b,'de'))
        .filter(k => k.toLowerCase().includes(filter.toLowerCase()));
      keys.forEach(k=>{
        const item = document.createElement('div');
        item.className = 'cat-item' + (tmpSelectedCategories.includes(k) ? ' active' : '');
        item.innerHTML = `<span>${k}</span> <span class="muted">${kategorien[k].length} Begriffe</span>`;
        item.onclick = () => {
          const index = tmpSelectedCategories.indexOf(k);
          if (index > -1) {
            tmpSelectedCategories.splice(index, 1); // abwählen
            item.classList.remove('active');
          } else {
            tmpSelectedCategories.push(k); // auswählen
            item.classList.add('active');
          }
        };
        list.appendChild(item);
      });
      if(keys.length===0){
        const empty = document.createElement('div');
        empty.className='muted'; empty.style.padding='8px 4px';
        empty.textContent='Keine Treffer';
        list.appendChild(empty);
      }
    }
    function filterCategories(){
      buildCategoryList($('#catSearch').value.trim());
    }
    function chooseRandom(){
      const keys = Object.keys(kategorien);
      if(!keys.length) return;
      tmpSelectedCategories = [keys[Math.floor(Math.random()*keys.length)]];
      applyCategory();
    }
    function applyCategory() {
      aktiveKategorien = [...tmpSelectedCategories];
      updateCategoryButtonLabel();
      closeCatModal();
    }
    // ----------- Kategorien/Begriff ziehen -----------
    function zieheBegriff() {
      if (!aktiveKategorien.length) {
        const keys = Object.keys(kategorien);
        aktiveKategorien = [keys[Math.floor(Math.random() * keys.length)]];
      }

      const zufallsKategorie = aktiveKategorien[Math.floor(Math.random() * aktiveKategorien.length)];
      const begriffe = kategorien[zufallsKategorie];
      aktuellerBegriff = begriffe[Math.floor(Math.random() * begriffe.length)];
    }

    // ----------- Setup: Spieler -----------
    function renderPlayers() {
      const list = $('#playerList');
      list.innerHTML = '';
      players.forEach((name, i) => {
        const row = document.createElement('div');
        row.className = 'player-item';

        // Input-Feld für Name
        const input = document.createElement('input');
        input.type = 'text';
        input.value = name;
        input.className = 'player-name-input';
        input.onchange = () => { players[i] = input.value.trim() || `Spieler ${i+1}`; };

        // Entfernen-Button
        const del = document.createElement('button');
        del.className = 'del';
        del.textContent = 'Entfernen';
        del.onclick = () => { 
          players.splice(i,1); 
          renderPlayers(); 
        };

        row.appendChild(input);
        row.appendChild(del);
        list.appendChild(row);
      });
      $('#playerCount').textContent = `${players.length} Spieler`;
    }

    function addPlayer(){
      const inp = $('#playerInput');
      const name = inp.value.trim();
      if(!name) return;
      if(players.length >= 20){ alert('Maximal 20 Spieler.'); return; }
      players.push(name);
      inp.value = '';
      renderPlayers();
    }

    // ----------- Flow: Start -> Setup -> Karten -----------
    function beginCards(){
      if(players.length < 3){ alert('Mindestens 3 Spieler!'); return; }

      // Imposter zufällig wählen
      const count = parseInt($('#imposterCount').value,10);
      impostersIdx = [];
      while(impostersIdx.length < count){
        const r = Math.floor(Math.random()*players.length);
        if(!impostersIdx.includes(r)) impostersIdx.push(r);
      }

      // Kategorie + Begriff ziehen
      zieheBegriff();

      // Timer-Setup
      timerActive = $('#timerSwitch').checked;
      if(timerActive){
        const mins = parseInt($('#timerMinutes').value,10);
        timerTotalSec = mins * 60;
        timerLeft = timerTotalSec;
      } else {
        timerTotalSec = 0; timerLeft = 0;
      }

      currentIndex = 0;
      navTo('cards');
      showCardUI();
    }

    function showCardUI() {
      $('#cardPlayerName').textContent = players[currentIndex];
      
      const card = $('#revealCard');
      $('#cardMainText').textContent = 'Karte aufdecken';   // nur den Text setzen
      $('#cardHintText').style.display = 'none';            // Hinweis verstecken

      card.classList.add('hidden');
      
      const btn = $('#nextBtn');
      btn.textContent = (currentIndex === players.length - 1) ? 'Spiel starten' : 'Weitergeben';
      btn.style.display = 'none';
    }

    function revealCurrent() {
      const card = $('#revealCard');
      if (!card.classList.contains('hidden')) return;

      const main = $('#cardMainText');
      const hint = $('#cardHintText');
      const hintsOn = $('#hintsSwitch').checked;
      const isImposter = impostersIdx.includes(currentIndex);

      if (isImposter) {
        main.textContent = "Du bist der Imposter!";
        if (hintsOn && aktuellerBegriff && aktuellerBegriff.hinweis) {
          hint.textContent = aktuellerBegriff.hinweis;
          hint.style.display = 'block';
        } else {
          hint.style.display = 'none';
        }
      } else {
        main.textContent = aktuellerBegriff ? aktuellerBegriff.wort : '—';
        hint.style.display = 'none';
      }

      card.classList.remove('hidden');
      $('#nextBtn').style.display = 'block';
    }

    function nextCard(){
      if(currentIndex === players.length-1){
        startPlayScreen();
      }else{
        currentIndex++;
        showCardUI();
      }
    }

    function restartToSetup(){
      stopTimer();
      navTo('setup');
    }

    // ----------- Spiel-Screen -----------
    function startPlayScreen(){
      navTo('play');

      // Zufälliger Startspieler
      const starterIdx = Math.floor(Math.random()*players.length);
      $('#starter').textContent = players[starterIdx];

      // Timer
      if(timerActive){
        updateTimerUI();
        startTimer();
      }else{
        $('#timerBox').textContent = 'Kein Timer';
      }
      $('#revealOut').style.display = 'none';
    }

    function revealImposters(){
      const names = impostersIdx.map(i => players[i]);
      const out = $('#revealOut');
      out.style.display = 'block';
      out.innerHTML = `<div style="font-weight:800; margin-bottom:6px">Imposter:</div>${names.map(n=>`• ${n}`).join('<br>')}`;
      stopTimer();
    }

    // ----------- Timer -----------
    function startTimer(){
      stopTimer();
      timerInterval = setInterval(()=>{
        timerLeft = Math.max(0, timerLeft-1);
        updateTimerUI();
        if(timerLeft <= 0){
          stopTimer();
          if(navigator.vibrate) navigator.vibrate(200);
          alert('Zeit abgelaufen!');
        }
      }, 1000);
    }
    function stopTimer(){
      if(timerInterval){ clearInterval(timerInterval); timerInterval = null; }
    }
    function updateTimerUI(){
      const m = Math.floor(timerLeft/60).toString().padStart(2,'0');
      const s = (timerLeft%60).toString().padStart(2,'0');
      $('#timerBox').textContent = `${m}:${s}`;
    }

    // ----------- Navigation Hilfen -----------
    function navGuard(){
      history.pushState(null, '', location.href);
      window.onpopstate = ()=> history.go(1);
    }
    navGuard();

    // Demo: ein paar Startnamen
    players = ['Spieler 1','Spieler 2','Spieler 3'];
    renderPlayers();
    // =====================================================
    // ============ Lügner: State & Laden Fragen ============
    // =====================================================
    let liarPlayers = [];
    let liarIndices = [];        // Index(e) der Lügner
    let liarCurrentIndex = 0;

    let liarCategories = {};     // Daten aus fragen.json -> {Kategorie:[{frage, lügner}, ...]}
    let liarActiveCategories = [];
    let liarTmpSelected = [];

    let liarAssigned = [];       // pro Spieler: {question: string, isLiar: boolean}
    let liarAnswers = [];        // pro Spieler: string
    let liarPublicQuestion = ""; // die „normale“ Frage, die allen angezeigt wird

    // Fragen laden
    fetch("fragen.json")
      .then(r => r.json())
      .then(data => {
        liarCategories = data;
        liarUpdateCatBadge();
      })
      .catch(err => console.error("Fehler beim Laden der Fragen:", err));

    // =====================================================
    // ============ Lügner: Setup / Spieler UI =============
    // =====================================================
    function liarRenderPlayers(){
      const list = document.getElementById('liarPlayerList');
      list.innerHTML = '';
      liarPlayers.forEach((name, i) => {
        const row = document.createElement('div');
        row.className = 'player-item';

        const input = document.createElement('input');
        input.type = 'text';
        input.value = name;
        input.className = 'player-name-input';
        input.onchange = () => { liarPlayers[i] = input.value.trim() || `Spieler ${i+1}`; };

        const del = document.createElement('button');
        del.className = 'del';
        del.textContent = 'Entfernen';
        del.onclick = () => { liarPlayers.splice(i,1); liarRenderPlayers(); };

        row.appendChild(input);
        row.appendChild(del);
        list.appendChild(row);
      });
      document.getElementById('liarPlayerCount').textContent = `${liarPlayers.length} Spieler`;
    }
    function liarAddPlayer(){
      const inp = document.getElementById('liarPlayerInput');
      const name = inp.value.trim();
      if(!name) return;
      if(liarPlayers.length >= 15){ alert('Maximal 15 Spieler.'); return; }
      liarPlayers.push(name);
      inp.value = '';
      liarRenderPlayers();
    }

    // =====================================================
    // ============ Lügner: Kategorien-Modal ===============
    // =====================================================
    function liarUpdateCatBadge(){
      const badge = document.getElementById('liarCatBadge');
      badge.textContent = liarActiveCategories.length ? liarActiveCategories.join(', ') : 'Zufällig';
    }
    function liarOpenCatModal(){
      if(Object.keys(liarCategories).length === 0){
        alert("Kategorien werden noch geladen...");
        return;
      }
      liarTmpSelected = [...liarActiveCategories];
      liarBuildCatList();
      document.getElementById('liarCatSearch').value = '';
      document.getElementById('liarCatModal').classList.add('show');
      document.body.style.overflow = 'hidden';
    }
    function liarCloseCatModal(){
      document.getElementById('liarCatModal').classList.remove('show');
      document.body.style.overflow = '';
    }
    function liarBuildCatList(filter=''){
      const list = document.getElementById('liarCatList');
      list.innerHTML = '';
      let keys = Object.keys(liarCategories)
        .filter(k => k.toLowerCase().includes(filter.toLowerCase()))
        .sort((a, b) => {
          if (a === "18+") return 1;
          if (b === "18+") return -1;
          return a.localeCompare(b, 'de');
      });
      keys.forEach(k=>{
        const item = document.createElement('div');
        item.className = 'cat-item' + (liarTmpSelected.includes(k) ? ' active' : '');
        item.innerHTML = `<span>${k}</span> <span class="muted">${liarCategories[k].length} Fragen</span>`;
        item.onclick = ()=>{
          const idx = liarTmpSelected.indexOf(k);
          if(idx>-1){ liarTmpSelected.splice(idx,1); item.classList.remove('active'); }
          else{ liarTmpSelected.push(k); item.classList.add('active'); }
        };
        list.appendChild(item);
      });
      if(keys.length===0){
        const empty = document.createElement('div');
        empty.className='muted'; empty.style.padding='8px 4px';
        empty.textContent='Keine Treffer';
        list.appendChild(empty);
      }
    }
    function liarFilterCategories(){ liarBuildCatList(document.getElementById('liarCatSearch').value.trim()); }
    function liarChooseRandomCategory() {
      const keys = Object.keys(liarCategories)
        .filter(k => k !== "18+" && k !== "Dark & Tabu"); // diese beiden ausschließen

      if (!keys.length) return;

      tmpSelectedLiarCategories = [keys[Math.floor(Math.random() * keys.length)]];
      applyLiarCategory();
    }
    function liarApplyCategories(){
      liarActiveCategories = [...liarTmpSelected];
      liarUpdateCatBadge();
      liarCloseCatModal();
    }

    // =====================================================
    // ============ Lügner: Flow – Start -> Karten =========
    // =====================================================
    function liarBeginCards(){
      if(liarPlayers.length < 3){ alert('Mindestens 3 Spieler!'); return; }

      // Lügner wählen
      const count = parseInt(document.getElementById('liarCount').value,10);
      liarIndices = [];
      while(liarIndices.length < count){
        const r = Math.floor(Math.random()*liarPlayers.length);
        if(!liarIndices.includes(r)) liarIndices.push(r);
      }

      // Frage aus Kategorie(n) ziehen
      if(!liarActiveCategories.length){
        const keys = Object.keys(liarCategories);
        liarActiveCategories = [ keys[Math.floor(Math.random()*keys.length)] ];
      }
      const cat = liarActiveCategories[Math.floor(Math.random()*liarActiveCategories.length)];
      const pair = liarCategories[cat][ Math.floor(Math.random()*liarCategories[cat].length) ];
      // pair: { frage, lügner }

      liarAssigned = liarPlayers.map((_,i)=>({
        question: liarIndices.includes(i) ? pair["lügner"] : pair["frage"],
        isLiar: liarIndices.includes(i)
      }));
      liarAnswers = new Array(liarPlayers.length).fill('');

      liarPublicQuestion = pair["frage"]; // diese zeigen wir später oben an

      liarCurrentIndex = 0;
      navTo('liar-cards');
      liarShowCardUI();
    }
    function liarShowCardUI(){
      document.getElementById('liarCardPlayerName').textContent = liarPlayers[liarCurrentIndex];

      const card = document.getElementById('liarRevealCard');
      card.classList.add('hidden');
      document.getElementById('liarCardMainText').textContent = 'Karte aufdecken';

      // Antwortbereich resetten
      document.getElementById('liarAnswerWrap').style.display = 'none';
      document.getElementById('liarAnswerInput').value = '';

      const btn = document.getElementById('liarNextBtn');
      btn.textContent = (liarCurrentIndex === liarPlayers.length-1) ? 'Zur Übersicht' : 'Weitergeben';
      btn.style.display = 'none';
    }
    function liarRevealCurrent(){
      const card = document.getElementById('liarRevealCard');
      if(!card.classList.contains('hidden')) return;
      const q = liarAssigned[liarCurrentIndex].question;
      document.getElementById('liarCardMainText').textContent = q;
      card.classList.remove('hidden');

      document.getElementById('liarQuestionShown').textContent = q;
      document.getElementById('liarAnswerWrap').style.display = 'block';
      document.getElementById('liarNextBtn').style.display = 'block';
    }
    function liarSaveAnswer(){
      const v = document.getElementById('liarAnswerInput').value.trim();
      liarAnswers[liarCurrentIndex] = v || '—';
      alert('Antwort gespeichert');
    }
    function liarNextCard(){
      const input = document.getElementById('liarAnswerInput');
      if (input) {
        liarAnswers[liarCurrentIndex] = input.value.trim() || '—';
      }

      if (liarCurrentIndex === liarPlayers.length - 1) {
        navTo('liar-results');
        liarBuildResults();
      } else {
        liarCurrentIndex++;
        liarShowCardUI();
      }
    }
    function liarRestartToSetup(){
      navTo('liar-setup');
    }

    // =====================================================
    // ============ Lügner: Ergebnisse + Reveal ============
    // =====================================================
    function liarBuildResults(){
      document.getElementById('liarPublicQuestion').textContent = liarPublicQuestion;
      const grid = document.getElementById('liarAnswersGrid');
      grid.innerHTML = '';
      liarPlayers.forEach((name,i)=>{
        const card = document.createElement('div');
        card.className = 'answer-card';
        card.dataset.index = String(i);
        card.innerHTML = `
          <div class="answer-name">${name}</div>
          <div class="answer-text">${(liarAnswers[i]||'—')}</div>
        `;
        grid.appendChild(card);
      });
    }
    function liarRevealLiars(){
      const grid = document.getElementById('liarAnswersGrid');
      liarIndices.forEach(i=>{
        const el = grid.querySelector(`.answer-card[data-index="${i}"]`);
        if(el) el.classList.add('liar');
      });
    }
    liarPlayers = ['Spieler 1','Spieler 2','Spieler 3'];
    liarRenderPlayers();
  </script>
</body>
</html>
